<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§è¯¾å ‚ç®¡ç†å¹³å°</title>
  <style>
    :root {
      --bg-color: #e8f5e9;
      --text-color: #2e7d32;
    }

    body {
      background-color: var(--bg-color);
      margin: 0;
      min-height: 100vh;
      font-family: Arial, sans-serif;
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    header {
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 30px;
    }

    .main-container {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      justify-content: center;
      align-items: flex-start;
      max-width: 1200px;
      width: 100%;
    }

    .input-area, .blackboard {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
    }

    textarea {
      height: 150px;
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 2px solid #81c784;
      border-radius: 8px;
      resize: vertical;
    }

    .config-section {
      background: #f0fff0;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .group-list, .group-box {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      justify-content: center;
      margin-top: 20px;
    }

    .group-title {
      font-weight: bold;
      text-align: center;
      line-height: 28px;
      color: #2e7d32;
    }

    .member-item {
      display: inline-block;
      background: #c8e6c9;
      color: #2e7d32;
      padding: 6px 12px;
      border-radius: 4px;
    }

    .hidden {
      display: none;
    }

    #qrcode-output, #groups-display {
      margin-top: 30px;
      min-width: 100%;
    }

    button {
      padding: 10px;
      border-radius: 6px;
      background: #81c784;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #66bb6a;
    }
  </style>
</head>
<body>

  <header>æ™ºæ…§è¯¾å ‚ç®¡ç†å¹³å°</header>

  <div class="main-container">

    <!-- å·¦ä¾§è¾“å…¥æ¨¡å— -->
    <div class="input-area">
      <label>è¯·è¾“å…¥å§“åï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
      <textarea id="name-list" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰&#10;æå››"></textarea>

      <div class="config-section">
        <input type="file" id="file-upload" accept=".txt" hidden>
        <button onclick="document.getElementById('file-upload').click()">ä¸Šä¼ TXTåå•</button>
      </div>

      <div class="config-section">
        <button onclick="randomGroup()">éšæœºåˆ†ç»„</button>
        <button onclick="exportGroupsToExcel()">å¯¼å‡ºåˆ†ç»„ç»“æœï¼ˆExcelï¼‰</button>
      </div>

      <!-- QRCodeæ¨¡å— -->
      <div class="config-section qrcode-section">
        <h3>äºŒç»´ç ç”Ÿæˆå™¨</h3>
        <button onclick="shareGroupsQRCode()">ç”Ÿæˆåˆ†ç»„åˆ†äº«äºŒç»´ç </button>
        <div id="qrcode-output"></div>
      </div>
    </div>

    <!-- å³ä¾§æ˜¾ç¤ºæ¨¡å— -->
    <div class="blackboard">
      <h3 id="name-display">å‡†å¤‡å°±ç»ª</h3>
      <div id="groups-display"></div>
    </div>

  </div>

  <!-- å¼•å…¥ä¾èµ– -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode"></script>

  <script>

    let teachers = [];

    const nameList = document.getElementById('name-list');
    const fileInput = document.getElementById('file-upload');
    const groupsDisplay = document.getElementById('groups-display');

    // HTMPL æ¨¡æ¿
    function templateGroupCard(groupName, members) {
      return `<div class="group-box">
                <div class="group-title">${groupName}</div>
                ${members.map(m => `<span class="member-item">${m}</span>`).join('')}
              </div>`
    }

    nameList.addEventListener('input', updateTeachers);
    fileInput.addEventListener('change', handleFileUpload);

    function updateTeachers(content) {
      teachers = content.split('\n').map(n => n.trim()).filter(n => n);
    }

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        const result = ev.target.result;
        nameList.value = result;
        updateTeachers(result);
      };
      reader.readAsText(file);
    }

    function randomGroup() {
      if (teachers.length === 0) {
        alert("è¯·å…ˆè¾“å…¥å§“ååˆ—è¡¨æˆ–ä¸Šä¼ æ–‡ä»¶");
        return;
      }
      const count = 3;
      const shuffled = [...teachers].sort(() => Math.random() - 0.5);
      let html = '';
      for (let i = 0; i < count; i++) {
        const members = shuffled.filter((_, index) => index % count === i);
        html += templateGroupCard(`ç¬¬ ${i + 1} ç»„`, members);
      }
      groupsDisplay.innerHTML = html;
    }

    // âœ… Excel å¯¼å‡ºåŠŸèƒ½
    function exportGroupsToExcel() {
      const groups = document.querySelectorAll('.group-box');
      if (groups.length === 0) {
        alert('è¯·å…ˆè¿›è¡Œåˆ†ç»„ï¼Œå†ç‚¹å‡»å¯¼å‡ºæŒ‰é’®');
        return;
      }

      const workbook = XLSX.utils.book_new();

      groups.forEach(group => {
        const name = group.querySelector('.group-title').textContent;
        const names = [...group.querySelectorAll('.member-item')].map(el => el.textContent.trim());

        const wsArr = [[name], ['å§“å']];
        names.forEach(n => wsArr.push([n]));

        const worksheet = XLSX.utils.aoa_to_sheet(wsArr);
        let sheetName = name.substring(0, 31);
        let i = 1;

        while (workbook.SheetNames.includes(sheetName)) {
          sheetName = name + '_' + i++;
        }

        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
      });

      XLSX.writeFile(workbook, 'è¯¾å ‚åˆ†ç»„ç»“æœ.xlsx');
      alert('å·²å®Œæˆåˆ†ç»„ Excel æ–‡ä»¶å¯¼å‡ºï¼Œè¯·æ³¨æ„æµè§ˆå™¨ä¸‹è½½æç¤º');
    }

    // âœ… åˆ†ç»„åˆ†äº«äºŒç»´ç ç”Ÿæˆï¼ˆå«åˆ†ç»„æ•°æ®ï¼‰
    function shareGroupsQRCode() {
      const groups = document.querySelectorAll('.group-box');
      if (groups.length === 0) {
        alert('è¯·å…ˆè¿›è¡Œåˆ†ç»„ï¼Œå†ç”ŸæˆäºŒç»´ç ');
        return;
      }

      const data = Array.from(groups).map(group => {
        return {
          name: group.querySelector('.group-title').textContent,
          members: [...group.querySelectorAll('.member-item')].map(m => m.textContent.trim())
        };
      });

      const encoded = encodeURIComponent(JSON.stringify(data));
      const url = `${location.href.split('#')[0]}#groups:${encoded}`;
      document.getElementById("qrcode-output").innerHTML = '';
      QRCode.toCanvas(url, { width: 200 }, function (err, canvas) {
        if (err) {
          alert('ç”ŸæˆäºŒç»´ç æ—¶å‡ºé”™ï¼š' + err.message);
          return;
        }
        document.getElementById('qrcode-output').appendChild(canvas);
      });
    }

    // ğŸ“± **å¦‚æœä»äºŒç»´ç æ‰“å¼€é¡µé¢ï¼Œå¯ç›´æ¥æ˜¾ç¤ºåˆ†ç»„ä¿¡æ¯**
    window.addEventListener('load', () => {
      const hash = location.hash;
      if (hash && hash.startsWith('#groups:')) {
        const dataStr = decodeURIComponent(hash.slice(8));
        try {
          const data = JSON.parse(dataStr);
          let html = data.map(g => templateGroupCard(g.name, g.members)).join('');
          groupsDisplay.innerHTML = html;
        } catch (e) {
          alert("æ— æ•ˆçš„åˆ†ç»„äºŒç»´ç ");
        }
      }
    });

  </script>

</body>
</html>